---
title: "Bombus pesticide exposure: gene expression in head"
output: plot_go_barchart.html
authors: Joe Colgan (joscolgan)
---

## Introduction:  

This script is for visualisation of the output of gene ontology (GO) analyses using the R package TopGo.
This script creates a barchart of the number of significant genes annotated to a particular GO term, with an associated p-value. This script takes an input of .csv files containing an output table of GO analyses.

```{r, message = FALSE}
# Load libraries; install from scratch if needed
libraries <- c("ggplot2", "lattice", "ggpubr")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
        library(lib, character.only = TRUE )
    }
}

## Create output directory:
dir.create("results/figures/",
           recursive = TRUE)
```

## Step One: Load input files
Read in files for the output of Gene Ontology enrichment analysis.

Load results from diapause samples:

```{r, message = FALSE}
## Read in biological processes GO terms:
gowinda_terms <- read.table(file = "results/gowinda/input_for_r.txt",
                       header = FALSE)

## Update column names:
colnames(gowinda_terms) <- c("GO_id",
                             "average_gene_num_across_sims",
                             "number_of_genes_per_go_term_with_sig_snps",
                             "raw_pvalue",
                             "fdr",
                             "num_genes_in_go_category_with_sig_snps",
                             "num_genes_in_go_category_with_snps",
                             "total_num_genes",
                             "go_term_description")
```

For each time-point, combine gene ontolgy terms for plotting:

```{r, message = FALSE}
## Log transform p values for plotting:
gowinda_terms$log_of_fdr <- -log(gowinda_terms$fdr)

## For plotting, update GO term names to include total number of annotated terms:
gowinda_terms$updated_terms <- paste(gowinda_terms$go_term_description,
                                      " ",
                                      "(",
                                      gowinda_terms$total_num_genes,
                                      ")",
                                      sep = "")

## Remove underscore:
gowinda_terms$updated_terms <- gsub("_", " ", gowinda_terms$updated_terms)

## Filter by significant fdr:
gowinda_terms <- subset(gowinda_terms,
                        raw_pvalue < 0.05)

## Generate plot:
gowinda_terms_plot <- ggbarplot(gowinda_terms,
                                          x = "updated_terms",
                                          y = "log_of_fdr",
                                          position = position_dodge(0.1),
                                          fill = "orange",
                                          color = NULL,
                                          palette = "jco",
                                          sort.val = "asc",
                                          sort.by.groups = TRUE,
                                          ylab = "-log10(p)",
                                          xlab = "Gene ontology term",
                                          legend.title = "Gene ontology",
                                          lab.col = "black",
                                          lab.size = 4,
                                          lab.vjust = 0.5,
                                          lab.hjust = 1,
                                          legend = "top",
                                          rotate = TRUE,
                                          ggtheme = theme_minimal())

## Make font bigger and bold:
gowinda_terms_plot <- gowinda_terms_plot +
        scale_y_continuous(expand = c(0, 0)) +
        theme(axis.text = element_text(size = 15),
              axis.title.x = element_text(size = 15,
                                          face = "bold"),
              axis.title.y = element_text(size = 15,
                                          face = "bold"),
              axis.text.y = element_text(size = 12,
                                         face = "bold"),
              axis.text.x = element_text(size = 12),
              legend.position = "none") +
        expand_limits(y = 20) +
        geom_hline(yintercept = 1.301,
                   linetype = "dashed",
                   colour = "black")

## Print to console:
gowinda_terms_plot

## Save picture:
ggsave(file = "results/figures/gowinda_go_terms_barchart.png",
       height = 12,
       width = 14)
```

Run lintr:

```{r, message = FALSE}
## Run lintr
lintr::lint(file = "./plot_go_barchart.Rmd")
```