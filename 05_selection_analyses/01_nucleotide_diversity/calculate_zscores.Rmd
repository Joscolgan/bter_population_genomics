---
title: "Bombus population genomics"
output: calculate_zscores.html
author: Joe Colgan, Yannick Wurm http://wurmlab.com
---

## Introduction:
The purpose of this script is to identify genomic regions of significantly reduced nucleotie diversity, which may be indicative of recent hard selective sweeps. 
The script takes as input a tab-delimited text file containing nucleotide diversity (pi) and Tajima's D estimates for 100kb sliding windows generated by [PopGenome](https://cran.r-project.org/web/packages/PopGenome/index.html).  
The script z-score transforms pop gen estimates for each windows and calculates a p-value per window.  
The script outputs a table containing these p-values with each row representative of a 100kb sliding window.  
The script also saves and outputs the entire analysis as an R object.

1. Load libraries:

```{r, message = FALSE}
## Load libraries:
libraries <- c("lintr",
               "ggplot2",
               "ggpubr")
for (lib in libraries) {
        if (require(package = lib, character.only = TRUE)) {
                print("Successful")
        } else {
                print("Installing")
                source("https://bioconductor.org/biocLite.R")
                biocLite(pkgs = lib)
                library(lib, character.only = TRUE)
        }
}

## Create output folder:
dir.create(path = "./results/figures",
           recursive = TRUE)
```

2. Read in input data:

```{r, message = FALSE}
## Read in input file:
data <- read.table(file = "./results/bter_all_chrom_100kb_approx_F_jump_size_zero.txt",
                   header = TRUE)

## Calculate z-score for nucleotide diversity:
data_nd_sd <- sd(data$nuc_diversity) *
                 sqrt((length(data$nuc_diversity) - 1) /
                              (length(data$nuc_diversity)))
data_nd_mean <- mean(data$nuc_diversity)

data$nd_zscores <- (data$nuc_diversity - data_nd_mean) / data_nd_sd

## Calculate p value:
data$nd_pvalue2sided <- 2 * pnorm(-abs(data$nd_zscores))

## Calculate z-score for Tajima's D:
data_td_sd <- sd(data$tajima_d) *
              sqrt((length(data$tajima_d) - 1) /
                           (length(data$tajima_d)))
data_td_mean <- mean(data$tajima_d)

data$td_zscores <- (data$tajima_d - data_td_mean) / data_td_sd

## Calculate p value:
data$td_pvalue2sided <- 2 * pnorm(-abs(data$td_zscores))
```

3. Write the output to file:

```{r, message = FALSE}
## Turn off scientific notation:
options(scipen = 999)

## write to output
write.table(x = data,
            file = "./results/zscore_normalised.txt",
            row.names = FALSE,
            col.names = TRUE,
            quote = FALSE,
            sep = "\t")
```

4. Subset regions with significantly high or low estimates of :
1) nucleotide diversity;
2) Tajima's D.

```{r, message = FALSE}
## Subset significant terms:
data_nd_sig <- subset(data,
                      nd_pvalue2sided < 0.05)
data_td_sig <- subset(data,
                      tajima_d < 0 &
                      td_pvalue2sided < 0.05)

## Regions with low diversity and low Tajima's D:
nrow(subset(data,
       nd_pvalue2sided < 0.05 &
                tajima_d < 0 &
               td_pvalue2sided < 0.05))

## Save output:
save(data, file = "./results/zscore_normalised.Rdata")
```

5. Run lintr

```{r, message = FALSE}
lintr::lint(file = "./calculate_zscores.Rmd")
```
