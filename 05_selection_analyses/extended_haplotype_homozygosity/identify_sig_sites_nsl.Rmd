---
title: "Bombus population genomics"
output: identify_sig_sites_nsl.html
author: Joe Colgan, Yannick Wurm http://wurmlab.com 
---

## Introduction:  
This script takes the output of selscan as input.  
The input consists of tab-delimited text files, one per bumblebee chromosome, which contains the following information:  
1) Locus ID (chromosome name)
2) Physical position
3) '1' Freq
4) nsl1
5) nsl0
6) Unstandardised nsl
7) Standardised nsl
8) Indicator of 'unsual' or not (1 = unsual; 0 = not)

```{r, message = FALSE}
# Load libraries; install from scratch if needed
libraries <- c("ggplot2", "ggpubr", "lintr",
               "PopGenome", "zoo", "qqman")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
        library(lib, character.only = TRUE )
    }
}

## Create output directory:
dir.create("nsl_significant_sites")
```

Read in input:

```{r, message=FALSE}
## Read in data:
NC_015762.1_nsl_data <- read.table("./nsl/NC_015762.1.nsl.out.100bins.norm")
NC_015763.1_nsl_data <- read.table("./nsl/NC_015763.1.nsl.out.100bins.norm")
NC_015764.1_nsl_data <- read.table("./nsl/NC_015764.1.nsl.out.100bins.norm")
NC_015765.1_nsl_data <- read.table("./nsl/NC_015765.1.nsl.out.100bins.norm")
NC_015766.1_nsl_data <- read.table("./nsl/NC_015766.1.nsl.out.100bins.norm")
NC_015767.1_nsl_data <- read.table("./nsl/NC_015767.1.nsl.out.100bins.norm")
NC_015768.1_nsl_data <- read.table("./nsl/NC_015768.1.nsl.out.100bins.norm")
NC_015769.1_nsl_data <- read.table("./nsl/NC_015769.1.nsl.out.100bins.norm")
NC_015770.1_nsl_data <- read.table("./nsl/NC_015770.1.nsl.out.100bins.norm")
NC_015771.1_nsl_data <- read.table("./nsl/NC_015771.1.nsl.out.100bins.norm")
NC_015772.1_nsl_data <- read.table("./nsl/NC_015772.1.nsl.out.100bins.norm")
NC_015773.1_nsl_data <- read.table("./nsl/NC_015773.1.nsl.out.100bins.norm")
NC_015774.1_nsl_data <- read.table("./nsl/NC_015774.1.nsl.out.100bins.norm")
NC_015775.1_nsl_data <- read.table("./nsl/NC_015775.1.nsl.out.100bins.norm")
NC_015776.1_nsl_data <- read.table("./nsl/NC_015776.1.nsl.out.100bins.norm")
NC_015777.1_nsl_data <- read.table("./nsl/NC_015777.1.nsl.out.100bins.norm")
NC_015778.1_nsl_data <- read.table("./nsl/NC_015778.1.nsl.out.100bins.norm")
NC_015779.1_nsl_data <- read.table("./nsl/NC_015779.1.nsl.out.100bins.norm")
```


```{r, message = FALSE}
##Â Make a list:
nsl_samples <- list(NC_015762.1_nsl_data = NC_015762.1_nsl_data,
                    NC_015763.1_nsl_data = NC_015763.1_nsl_data,
                    NC_015764.1_nsl_data = NC_015764.1_nsl_data,
                    NC_015765.1_nsl_data = NC_015765.1_nsl_data,
                    NC_015766.1_nsl_data = NC_015766.1_nsl_data,
                    NC_015767.1_nsl_data = NC_015767.1_nsl_data,
                    NC_015768.1_nsl_data = NC_015768.1_nsl_data,
                    NC_015769.1_nsl_data = NC_015769.1_nsl_data,
                    NC_015770.1_nsl_data = NC_015770.1_nsl_data,
                    NC_015771.1_nsl_data = NC_015771.1_nsl_data,
                    NC_015772.1_nsl_data = NC_015772.1_nsl_data,
                    NC_015773.1_nsl_data = NC_015773.1_nsl_data,
                    NC_015774.1_nsl_data = NC_015774.1_nsl_data,
                    NC_015775.1_nsl_data = NC_015775.1_nsl_data,
                    NC_015776.1_nsl_data = NC_015776.1_nsl_data,
                    NC_015777.1_nsl_data = NC_015777.1_nsl_data,
                    NC_015778.1_nsl_data = NC_015778.1_nsl_data,
                    NC_015779.1_nsl_data = NC_015779.1_nsl_data)
```


##Step Two:
## For the examination of interest peak regions with certain size windows:
## The following command will take the absolute nSL values and for nonoverlapping 50kb sites,
## calculate the number of SNPs with nSL values with a value higher than 2 (potentially interesting)
## divided by the total number of SNPs i.e. get the proportion of interesting SNPs within a particular
## region.

```{r, message = FALSE}
## Create an empty dataframe:
df <- data.frame()

## For each sample in the list:
for (name in nsl_samples){
        ## Examine 100 lines at a time (representative of SNPs),
        ## count the proportion of SNPs with an interesting nSL value.
        name.rolled <- rollapply(abs(name$V7),
                                width = 100,
                                by = 100,
                                function(x) sum(x > 2.56) / 100)
        ## Add the count proportion per window to the empty dataframe:
        df <- c(df, name.rolled)
        ## Unlist the contents of the dataframe:
        df <- unlist(df)
}

## Multiply the contents of the dataframe to get the integer counts of SNPs:
snp_counts <- df * 100
## Combine proportional counts with actual integer counts and store in a dataframe:
unlisted.df <- as.data.frame(cbind(df, snp_counts))

## Perform a binomial probability function test on count data:
unlisted.df$binom_test <- pbinom(q = unlisted.df$snp_counts,
                                 size = 100,
                                 lower.tail = FALSE,
                                 prob = sum(unlisted.df$snp_counts) / (nrow(unlisted.df) * 100))
unlisted.df$binom_test_adjusted <- p.adjust(p = unlisted.df$binom_test,
                                            method = "BH")
## Correct for multiple testing using bonferroni correction:
unlisted.df$binom_test_adjusted <- p.adjust(p = unlisted.df$binom_test,
                                            method = "bonferroni")

## Examine the proportion of SNPs with significance values:
unlisted.df.sig <- unlisted.df[which(unlisted.df$binom_test_adjusted < 0.05), ]
table(unlisted.df.sig$df) ## Lowest proportion is 0.15
```


## Convert the input text files into zoo formatted files:
#for (item in 1:length(names(nsl.samples))){
#        nsl.samples[[item]] <- zoo((nsl.samples)[[item]])
#}

```{r, message=FALSE}
## Before examining individual sites:
## Want to plot on a manhattan plot using qqman:
## Loop through the 'zoo' samples:
## Add column containing chromosomal number to each chromosome:
count <- 0
for (item in 1:length(names(nsl_samples))){
        count <- count + 1
        ## Add chromosome number to each individual chromosome:
        nsl_samples[[item]]$chrom <- count
}
```

Exploration of a Manhattan plot using qqman:

```{r, message = FALSE}
combined_test <- data.frame()

## For the generation of a manhattan plot:
## Require, "SNP", "CHR", "BP" and "P" columns:
for (item in 1:length(names(nsl_samples))){
        nsl_samples[[item]]$V1 <- sub("^", "rs", nsl_samples[[item]]$V1)
        nsl_samples[[item]] <- nsl_samples[[item]][, c(1, 9, 2, 7)]
        combined_test <- rbind(combined_test,
                               as.data.frame(nsl_samples[[item]]))
}

## Change the column names for plotting:
colnames(combined_test) <- c("SNP", "CHR", "BP", "P")

## Change the 'P' values to absolute values:
combined_test$P <- abs(combined_test$P)

## Plot:
manhattan(combined_test)
```

```{r, message = FALSE}

zoo_samples <- list(NC_015762.1_nsl_data = NC_015762.1_nsl_data,
                    NC_015763.1_nsl_data = NC_015763.1_nsl_data,
                    NC_015764.1_nsl_data = NC_015764.1_nsl_data,
                    NC_015765.1_nsl_data = NC_015765.1_nsl_data,
                    NC_015766.1_nsl_data = NC_015766.1_nsl_data,
                    NC_015767.1_nsl_data = NC_015767.1_nsl_data,
                    NC_015768.1_nsl_data = NC_015768.1_nsl_data,
                    NC_015769.1_nsl_data = NC_015769.1_nsl_data,
                    NC_015770.1_nsl_data = NC_015770.1_nsl_data,
                    NC_015771.1_nsl_data = NC_015771.1_nsl_data,
                    NC_015772.1_nsl_data = NC_015772.1_nsl_data,
                    NC_015773.1_nsl_data = NC_015773.1_nsl_data,
                    NC_015774.1_nsl_data = NC_015774.1_nsl_data,
                    NC_015775.1_nsl_data = NC_015775.1_nsl_data,
                    NC_015776.1_nsl_data = NC_015776.1_nsl_data,
                    NC_015777.1_nsl_data = NC_015777.1_nsl_data,
                    NC_015778.1_nsl_data = NC_015778.1_nsl_data,
                    NC_015779.1_nsl_data = NC_015779.1_nsl_data)

## Transform to zoo format
for (item in 1:length(names(zoo_samples))){
        zoo_samples[[item]] <- zoo((zoo_samples)[[item]])
}

## Need to examine sites for each chromosome with a SNP proportion of 0.15:
df.sig <- data.frame()
counts <- data.frame()
output.bed <- data.frame()

## Loop through the 'zoo' samples:
for (name in zoo_samples){
        ## 100 consecutive SNPs
        name.rolled <- rollapply(name$V7,
                                width = 100,
                                by = 100,
                                function(x) sum(x > 2.56) / 100)
        df.sig <- name.rolled[which(name.rolled >= 0.16)]
        df.sig.index <- (index(df.sig))
        df.index <- index(name.rolled)
        print(length(df.index))
        ## For each significant index in turn, do:
        for (i in df.index){
                ## Add 49 to each index to get the upper limit.
                df.sig.index.upper <- i + 49
                ## Add 50 to each index to get the lower limit.
                df.sig.index.lower <- i - 50
                name.subset <- name[df.sig.index.lower:df.sig.index.upper]
                ## Remove line that asks for only special SNPs
                name.subset.sig <- name.subset[which(name.subset$V8 == 1), ]
                counts <- c(counts, as.integer(tail(name.subset$V2, n = 1)) -
                                    as.integer(head(name.subset$V2, n = 1)))
                test <- cbind(as.integer(head(name.subset$V2, n = 1)),
                              as.integer(tail(name.subset$V2, n = 1)))
                output.bed <- rbind(output.bed, test)
        }
}

## Values for each chromosome are printed to screen. I haven't developed a more sleeker form
## for adding the numbers to the chromosomes here. 
## New analysis:
chromosome_name <- c(rep("NC_015762.1", 734),
                    rep("NC_015763.1", 651),
                    rep("NC_015764.1", 833),
                    rep("NC_015765.1", 689),
                    rep("NC_015766.1", 528),
                    rep("NC_015767.1", 680),
                    rep("NC_015768.1", 922),
                    rep("NC_015769.1", 493),
                    rep("NC_015770.1", 807),
                    rep("NC_015771.1", 675),
                    rep("NC_015772.1", 889),
                    rep("NC_015773.1", 606),
                    rep("NC_015774.1", 463),
                    rep("NC_015775.1", 503),
                    rep("NC_015776.1", 542),
                    rep("NC_015777.1", 241),
                    rep("NC_015778.1", 174),
                    rep("NC_015779.1", 115))

## Add chromosome names to dataframe:
output.bed$chromosome <- chromosome_name

nrow(unlisted.df)
nrow(output.bed)

## Combine genomic coordinates and statistical information:
combined.df <- cbind(output.bed, unlisted.df)

## Reorder columns:
combined.df.rearranged <- combined.df[, c(3, 1, 2, 4, 5, 6, 7)]

## Output file for filtering: 
## Filtering will involve examining the proportion of ambiguous ('N') bases 
## present within genomic windows. Windows with a high proportion (10%) of 
## Ns are to be removed. 
write.table(combined.df.rearranged,
            file = "nsl_n41_unfiltered.txt",
            sep = "\t",
            quote = FALSE,
            row.names = FALSE,
            col.names = FALSE)
```


```{r, message=FALSE}
## Read filtered file back in:
combined_df_rearranged_filtered <- read.table(file = "./nsl.44.samples.filtered.txt")

## Rename columns:
colnames(combined_df_rearranged_filtered) <- c("Chr",
                                               "Start",
                                               "End",
                                               "SNP_proportion",
                                               "snp_counts",
                                               "binom_test",
                                               "binom_test_adjusted")

## Identify genomic windows with significant number of nSL annotated SNPs:
combined_df_rearranged_filtered_sig_df <- combined_df_rearranged_filtered[which(combined_df_rearranged_filtered$binom_test_adjusted < 0.05), ]

## Subset top twenty sites with strongest signatures:
combined_df_rearranged_filtered_sig_df_top_twenty <- head(combined_df_rearranged_filtered_sig_df[order(combined_df_rearranged_filtered_sig_df$binom_test_adjusted), ], n = 20)

## Size of significant genomic windows:
combined_df_rearranged_filtered_sig_df$size <- combined_df_rearranged_filtered_sig_df$End - combined_df_rearranged_filtered_sig_df$Start

## Summarize the size of genomic windows:
summary(combined_df_rearranged_filtered_sig_df$size)

## Write top twenty sites to file:
write.table(combined_df_rearranged_filtered_sig_df_top_twenty,
            file = "./nsl.44.samples.filtered.toptwenty.txt",
            sep = "\t",
            quote = FALSE,
            row.names = FALSE,
            col.names = FALSE)
```

Run lintr:

```{r, message = FALSE}
## Run lintr:
lintr::lint(file = "./identify_sig_sites_nsl.Rmd")
```
