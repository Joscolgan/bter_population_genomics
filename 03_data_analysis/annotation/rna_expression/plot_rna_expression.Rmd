---
title: "Bombus population genomics"
output: plot_rna_expression.html
author: Joe Colgan, Yannick Wurm http://wurmlab.com
---

## Introduction:
This script takes gene-level counts calculated by tximport from kallisto estimated counts as input and
generates a line plot for a user-defined subset of genes. The output of the script is a PDF image.

```{r, message = FALSE}
require(ggplot2)
require(reshape2)
require(lintr)
```

## Load input data:
Read in data for two datasets:
1. The "Harrison" dataset consists of gene-level counts for 27 libraries consisting of different bumblebee life-cycle stages.
2. The "Lewis" datasets contains representative tissues of male and female germline and somatic tissues, respectively.
The gene level counts for each dataset are stored in R objects.

```{r, message = FALSE}
## Load R objects:
load(file = "./results/count_estimates/harrison_txi_count_estimates.Rdata")
```

## Read in a list of genes of interest:

```{r, message = FALSE}
## Genes of interest:
genes_of_interest <- scan(file = "./data/genes_of_interest.txt",
                          as.character())

## Read in sample information:
sample_information <- read.table(file = "./input/kallisto_rna_temp/worker_male_datasets/sample_information.txt",
                                 col.names = c("sample",
                                               "life_stage",
                                               "tissue",
                                               "sex"))

```

Subset gene-level counts for genes of interest:

```{r, message = FALSE}
## Subset genes of interest:
stage_txi_counts_df <- stages_txi_counts$counts
genes_of_interest_df <- subset(stage_txi_counts_df,
                               row.names(stage_txi_counts_df) %in% genes_of_interest)

## Add annotation for plotting:
genes_of_interest_df_trans <- as.data.frame(t(genes_of_interest_df))
genes_of_interest_df_trans$life_stage <- as.character(unlist(sample_information$life_stage))
genes_of_interest_df_trans$tissue <- as.character(unlist(sample_information$tissue))
genes_of_interest_df_trans$sex <- as.character(unlist(sample_information$sex))

## Remove unscore from status terms:
genes_of_interest_df_trans$life_stage <- gsub("_", " ", genes_of_interest_df_trans$life_stage)
```

Generate a scatterplot:

```{r, message = FALSE}
require(reshape2)
## Convert dataframe:
genes_of_interest_df_melt <- melt(genes_of_interest_df_trans)

## This identifies one gene that needs to be removed:
genes_of_interest %in% genes_of_interest_df_melt$variable
genes_of_interest_new <- c(genes_of_interest[1:32],
                           genes_of_interest[34:53])

## Correct the order of how the genes are plotted:
genes_of_interest_df_melt$variable <- factor(genes_of_interest_df_melt$variable,
                                                     levels = genes_of_interest_new)

## Generate plot:
life_stages_plot <- ggplot(data = genes_of_interest_df_melt,
                           aes(x = variable,
                               y = value)) +
        scale_fill_manual(name = "Life stage",
                            values = c("Brown",
                                       "Orange",
                                       "Grey",
                                       "Blue")) +
        geom_point(aes(fill = status),
                   colour = "black",
                   pch = 21,
                   alpha = 0.8,
                   size = 5) +
        ylab("Length-scaled TPM") +
        xlab("Locus ID") +
        theme_bw() +
        theme(axis.title = element_text(face = "bold"),
              legend.position = "bottom",
                axis.text.x = element_text(angle = 90,
                                           hjust = 1))

## Save image:
ggsave(file = "./results/rna_expression_chrom_1.png",
       height = 10,
       width = 10)
```

Run lintr to check style guide:

```{r, message = FALSE}
## Run lintr:
lintr::lint(file = "./plot_rna_expression.Rmd")
```