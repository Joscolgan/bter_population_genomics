

Rscript1.R
eg. run:
Rscript Rscript1.R annotations.txt interestinggenes.txt output_file
Author of the script is Avril Coghlan (http://avrilomics.blogspot.co.uk/2015/07/using-topgo-to-test-for-go-term.html)

This script takes in genes of interest and a database of genes and runs a Fisher Exact test for each of the ontologies:
- Biological processes (BP)
- Molecular function (MF)
- Cellular component (CC)

```{r}
### Load libraries#####
libraries <- c("topGO")
for (lib in libraries) {
        if (require(package = lib, character.only = TRUE)) {
                print("Successful")
        } else {
                print("Installing")
                source("https://bioconductor.org/biocLite.R")
                biocLite(pkgs = lib)
                library(lib, character.only = TRUE )
        }
}
```


Define the following:
1) Path to gene database containing genes and associated GO terms. 
2) Path to genes of interest to check for enrichment
3) The name of the output file
4) The number of nodes - this refers to the number of genes within your database that have a specific GO term. e.g. node=10 means each term must appear ten times. 
5) The type of ontology to term for: BP=Biological processes; MF=Molecular function; CC=Cellular component. 

```{r}
universeFile = "./input/bter_renamed_drosophila_go_terms.input_for_topgo.txt"
interestingGenesFile = "./input/genes_up_in_queen_vs_unreproductive_worker.under_selection.txt"
output_file = "queen_biased_genes_under_selection.gene_ids.MF.txt"
nodeSize_argument = 5
GO_term_type = "MF"

# set the output file
sink(output_file)
```


```{r}
# read in the 'gene universe' file
geneID2GO <- readMappings(file = universeFile)
geneUniverse <- names(geneID2GO)

# read in the genes of interest
genesOfInterest <- read.table(interestingGenesFile,header=FALSE)
genesOfInterest <- as.character(genesOfInterest$V1)
geneList <- factor(as.integer(geneUniverse %in% genesOfInterest))
names(geneList) <- geneUniverse

# build the GOdata object in topGO
myGOdata <- new("topGOdata", 
                description="My project", 
                ontology=GO_term_type, 
                allGenes=geneList,  
                annot = annFUN.gene2GO, 
                gene2GO = geneID2GO, 
                nodeSize=nodeSize_argument)

# run the Fisher's exact test:
resultWeight01 <- runTest(myGOdata, 
                        algorithm="weight01", 
                        statistic="fisher")

## Export
pValue_resultWeight01 <- score(resultWeight01)
pValue_resultWeight01 <- score(resultWeight01)[names(pValue_resultWeight01)]

# see how many results we get where weight01 gives a P-value <= 0.05:
## NB: The default score was 0.001
mysummary <- summary(attributes(resultWeight01)$score <= 0.05)
numsignif <- as.integer(mysummary[[3]]) # how many terms is it true that P <= 0.05

# print out the top 'numsignif' results:
allRes <- GenTable(myGOdata, 
                   weightfisher = resultWeight01, 
                   orderBy = "weightfisher", 
                   ranksOf = "weightfisher", 
                   topNodes = numsignif)

## Correct for multiple testing:
allRes$weightfisher_adjusted <- p.adjust(p=allRes$weightfisher,
                                         method="bonferroni",
                                         n=length(allRes$weightfisher))

## Work out if significant is greater than 0:
allRes_enriched <- allRes[which(allRes$Significant > allRes$Expected & allRes$Expected > 1), ]
nrow(allRes_enriched)

## Output table:
write.table(allRes_enriched, 
            file=output_file, 
            row.names = FALSE, 
            col.names = FALSE, 
            sep = "\t",
            quote = FALSE)

```




```{r}
# print a graph (to a pdf file) with the top 'numsignif' results:
#output_file2 = paste(output_file,"Topgo", sep="_")
#printGraph(myGOdata, resultTopgo, firstSigNodes = numsignif, fn.prefix = output_file2, useInfo = "all", pdfSW = TRUE)

# print out the genes that are annotated with the significantly enriched GO terms:
myterms <- allRes$GO.ID
mygenes <- genesInTerm(myGOdata, myterms)
for (i in 1:length(myterms))
{
   myterm <- myterms[i]
   mygenesforterm <- mygenes[myterm][[1]]
   myfactor <- mygenesforterm %in% genesOfInterest # find the genes that are in the list of genes of interest
   mygenesforterm2 <- mygenesforterm[myfactor == TRUE]
   mygenesforterm2 <- paste(mygenesforterm2, collapse=',')
   print(paste("Term",myterm,"genes:",mygenesforterm2))
}
# close the output file
sink()
```
